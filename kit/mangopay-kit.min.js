var mangoPay={cardRegistration:{baseURL:"https://api.sandbox.mangopay.com",clientId:"",init:function(e){this._cardRegisterData=e},registerCard:function(e,t,a){if(!mangoPay.browser.corsSupport())return void a({ResultCode:"009999",ResultMessage:"Browser does not support making cross-origin Ajax calls"});var r=mangoPay.cardRegistration._validateCardData(e);return r!==!0?void a(r):void mangoPay.cardRegistration._tokenizeCard(e,mangoPay.cardRegistration._finishRegistration,t,a)},_validateCardData:function(e){var t=mangoPay._validation._cardNumberValidator._validate(e.cardNumber);if(t!==!0)return t;var a=mangoPay._validation._expirationDateValidator._validate(e.cardExpirationDate,new Date);if(a!==!0)return a;var r=mangoPay._validation._cvvValidator._validate(e.cardCvx,e.cardType);return r!==!0?r:!0},_tokenizeCard:function(e,t,a,r){mangoPay._networking._ajax({type:"post",url:this._cardRegisterData.cardRegistrationURL,crossDomain:!0,data:{data:this._cardRegisterData.preregistrationData,accessKeyRef:this._cardRegisterData.accessKey,cardNumber:e.cardNumber,cardExpirationDate:e.cardExpirationDate,cardCvx:e.cardCvx},success:function(e){var n="";return null===e?void r({ResultCode:"001599",ResultMessage:"Token processing error"}):(n={Id:mangoPay.cardRegistration._cardRegisterData.Id,RegistrationData:e},void t(n,a,r))},error:function(e){r({ResultCode:"001599",ResultMessage:"Token processing error"})}})},_finishRegistration:function(e,t,a){mangoPay._networking._ajax({type:"post",crossDomain:!0,url:mangoPay.cardRegistration.baseURL+"/v2/"+mangoPay.cardRegistration.clientId+"/CardRegistrations/"+e.Id,data:e,success:function(e){try{e=JSON.parse(e)}catch(r){return void a({ResultCode:"101699",ResultMessage:"CardRegistration should return a valid JSON response"})}"000000"===e.ResultCode?t(e):a(e)},error:function(e){var t="CardRegistration error";if(e.response)try{var r=JSON.parse(e.response);r.Message&&(t=r.Message)}catch(n){}a({ResultCode:"101699",ResultMessage:t})}})}},_validation:{_cvvValidator:{_validate:function(e,t){if("MAESTRO"===t)return!0;if(e=e?e.trim():"",t=t?t.trim():"",mangoPay._validation._helpers._validateNumericOnly(e)===!0){if("AMEX"===t&&(3===e.length||4===e.length))return!0;if("CB_VISA_MASTERCARD"===t&&3===e.length)return!0}return{ResultCode:"105204",ResultMessage:"CVV_FORMAT_ERROR"}}},_expirationDateValidator:{_validate:function(e,t){if(e=e?e.trim():"",4===e.length){var a=parseInt(e.substr(2,2),10)+2e3,r=parseInt(e.substr(0,2),10);if(r>0&&12>=r){var n=t.getFullYear();if(a>n)return!0;if(n===a){var i=t.getMonth()+1;if(r>=i)return!0}return{ResultCode:"105203",ResultMessage:"PAST_EXPIRY_DATE_ERROR"}}}return{ResultCode:"105203",ResultMessage:"EXPIRY_DATE_FORMAT_ERROR"}}},_cardNumberValidator:{_validate:function(e){return e=e?e.trim():"",mangoPay._validation._helpers._validateNumericOnly(e)===!1?{ResultCode:"105202",ResultMessage:"CARD_NUMBER_FORMAT_ERROR"}:this._validateCheckDigit(e)===!1?{ResultCode:"105202",ResultMessage:"CARD_NUMBER_FORMAT_ERROR"}:!0},_validateCheckDigit:function(e){for(var t=0,a=0,r=!1,n=e.replace(/\D/g,""),i=n.length-1;i>=0;i--){var s=n.charAt(i),a=parseInt(s,10);r&&(a*=2)>9&&(a-=9),t+=a,r=!r}return t%10===0}},_helpers:{_validateNumericOnly:function(e){var t=/^[0-9]+$/;return e.match(t)?!0:!1}}},_networking:{_ajax:function(e){var t=new XMLHttpRequest,a="";for(var r in e.data)a+=(a.length>0?"&":"")+r+"="+encodeURIComponent(e.data[r]);var n=e.url;return"get"===e.type&&(n=e.url+(e.url.indexOf("?")>-1?"&":"?")+a),!e.crossDomain||"withCredentials"in t||!window.XDomainRequest?(t.onreadystatechange=function(){4==t.readyState&&(/^2[0-9][0-9]$/.test(t.status)?e.success(t.responseText):e.error(t,t.status,t.statusText))},t.open(e.type,n,!0),"post"===e.type&&t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),void t.send("post"===e.type?a:null)):(xdr=new XDomainRequest,xdr.onerror=function(){e.error(xdr)},xdr.onload=function(){e.success(xdr.responseText)},xdr.open(e.type,n),void xdr.send("post"===e.type?a:null))}},browser:{corsSupport:function(){return"withCredentials"in new XMLHttpRequest?!0:window.XDomainRequest?!0:!1}}};String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});
